# Starter pipeline

# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- develop

pool:
  vmImage: ubuntu-latest

stages:
- stage: Build
  displayName: Build and push stage
  jobs:
  - job: Build
    displayName: Build

    steps:
    - task: Docker@2
      inputs:
        command: 'build'
        Dockerfile: 'services/community/Dockerfile'

    - task: Docker@2
      inputs:
        command: 'build'
        Dockerfile: 'services/identity/Dockerfile'
    
    - task: Docker@2
      inputs:
        command: 'build'
        Dockerfile: 'services/web/Dockerfile'
      
    - task: Docker@2
      inputs:
        command: 'build'
        Dockerfile: 'services/workshop/Dockerfile'

    - task: DockerCompose@0
      inputs:
        containerregistrytype: 'Azure Container Registry'
        azureSubscription: 'AppConsultSandbox-to-Crapi'
        azureContainerRegistry: '{"loginServer":"crapi.azurecr.io", "id" : "/subscriptions/8863f50e-9a32-40a0-8fa2-22d245a31dba/resourceGroups/sidney-crapi-rg/providers/Microsoft.ContainerRegistry/registries/crapi"}'
        dockerComposeFile: '**/docker-compose.yml'
        action: 'Run a Docker Compose command'
        dockerComposeCommand: 'up -d'

    # - task: Docker@0
    #   displayName: Build image
    #   inputs:
    #     containerregistrytype: 'Azure Container Registry'
    #     azureSubscription: 'AppConsultSandbox-to-Crapi'
    #     azureContainerRegistry: '{"loginServer":"crapi.azurecr.io", "id" : "/subscriptions/8863f50e-9a32-40a0-8fa2-22d245a31dba/resourceGroups/sidney-crapi-rg/providers/Microsoft.ContainerRegistry/registries/crapi"}'

    # - task: Docker@0
    #   displayName: Push image
    #   inputs:
    #     azureSubscription: 'AppConsultSandbox-to-Crapi'
    #     azureContainerRegistry: '{"loginServer":"crapi.azurecr.io", "id" : "/subscriptions/8863f50e-9a32-40a0-8fa2-22d245a31dba/resourceGroups/sidney-crapi-rg/providers/Microsoft.ContainerRegistry/registries/crapi"}'
    #     action: 'Push an image'
    #     imageName: sidneymarie116/crapi:$(Build.BuildId)
    #     qualifyImageName: true

    # - task: AzureWebAppContainer@1
    #   inputs:
    #     azureSubscription: 'AppConsultSandbox-to-Crapi'
    #     appName: 'sidneycrapi'
    #     containers: 'crapi.azurecr.io/sidneymarie116/crapi:$(Build.BuildId)'
